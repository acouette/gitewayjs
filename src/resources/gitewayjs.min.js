/*! gitewayjs 2013-03-11 */
$(function(){giteway.views.search=new giteway.views.Search({model:giteway.collections.repositories}),Backbone.history.start()});var giteway=giteway||{};giteway.collections=giteway.collections||{};var GITHUB_ROOT="https://api.github.com",GITHUB_SEARCH_REPO="/legacy/repos/search/";(function(){"use strict";var e=Backbone.Model.extend(),t=Backbone.Collection.extend({model:e,keyword:"",search:function(e){this.keyword=e,this.url=GITHUB_ROOT+GITHUB_SEARCH_REPO+encodeURIComponent(e),this.fetch({dataType:"jsonp"})},parse:function(e){return e.data.repositories}});giteway.collections.repositories=new t})();var giteway=giteway||{};giteway.models=giteway.models||{},giteway.collections=giteway.collections||{},function(){"use strict";var e="https://api.github.com",t="/repos/:owner/:repo",i="/commits",o=Backbone.Model.extend({}),n=Backbone.Collection.extend({model:o,search:function(o,n){this.url=e+t.replace(":owner",o).replace(":repo",n)+i,this.fetch({dataType:"jsonp"})},parse:function(e){return e.data}});giteway.models.Repository=Backbone.Model.extend({defaults:{commits:new n,view:"timeline"},initialize:function(){this.get("commits").search(this.get("owner"),this.get("name"))},collaboration:function(){var e={count:this.get("commits").length},t=100/e.count;return e.data=this.get("commits").map(function(e){return e.get("author")?e.get("author").login:void 0}).reduce(function(e,i){return i in e?e[i]+=t:e[i]=t,e},{}),e},timeline:function(){var e=this.get("commits").map(function(e){return e.get("commit")&&e.get("commit").committer&&e.get("commit").committer.date?new Date(Date.parse(e.get("commit").committer.date)).getTime():void 0}),t=Math.max.apply(null,e),i=Math.min.apply(null,e),o=t-i,n=o/10,a={range:o,step:n,count:e.length};return a.data=e.reduce(function(e,t){for(var o=i;t>o+n;)o+=n;return e[o]=e[o]||0,e[o]++,e},{}),a}})}();var giteway=giteway||{};(function(){"use strict";var e=Backbone.Router.extend({currentView:void 0,routes:{"search/:keyword":"searchRepos","repo/:owner/:name":"statistics","*other":"init"},init:function(){console.log("init")},searchRepos:function(e){giteway.collections.repositories.search(e)},statistics:function(e,t){this.currentView&&this.currentView.remove();var i=new giteway.models.Repository({owner:e,name:t});this.currentView=new giteway.views.Statistics({model:i})}});giteway.router=new e})();var giteway=giteway||{};giteway.views=giteway.views||{},function(){"use strict";giteway.views.Repositories=Backbone.View.extend({tagName:"tr",className:function(){return Number(this.model.cid.slice(1))%2?"even":""},template:_.template($("#repositories-template").html()),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}})}();var giteway=giteway||{};giteway.views=giteway.views||{};var ENTER_KEY=13;(function(){"use strict";function e(e,t){clearTimeout(e.tId),e.tId=setTimeout(function(){e.call(t)},100)}giteway.views.Search=Backbone.View.extend({el:"#container",template:_.template($("#repositories-header-template").html()),events:{"click #search-button":"search","keypress #keyword":"searchOnEnter"},initialize:function(){this.$input=this.$("#keyword"),this.$result=this.$("#result"),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"request",this.request);var t=this;$(window).resize(function(){e(t.renderOnResize,this)})},renderOnResize:function(){console.log("onresize"+this.$el)},render:function(){this.$result.html(this.template());var e=$("#repo-list"),t=giteway.views.Repositories;return this.model.each(function(i){var o=new t({model:i});e.append(o.render().el)},this),this},search:function(){var e=this.$input.val().trim();e&&giteway.router.navigate("search/"+e,!0)},searchOnEnter:function(e){e.which===ENTER_KEY&&this.search()},request:function(){this.$input.val(this.model.keyword),this.$result.html("requesting...")}})})();var giteway=giteway||{};giteway.views=giteway.views||{},function(){"use strict";giteway.views.Statistics=Backbone.View.extend({el:"#stat",templateRepo:_.template($("#repo-template").html()),templateCollaboration:_.template($("#collaboration-template").html()),templateTimeline:_.template($("#timeline-template").html()),initialize:function(){var e=this;$("#result").html(this.templateRepo(this.model.toJSON())),this.$stat=$("#stat"),$("#btns-stats").children().click(function(){e.model.set("view",this.id.slice(4))}),this.listenTo(this.model.get("commits"),"reset",this.render),this.listenTo(this.model,"change:view",this.render)},render:function(){switch(console.log("render : "+this.model.get("view")),this.model.get("view")){case"collaboration":this.drawCollaboration();break;case"timeline":this.drawTimeline()}return this},drawTimeline:function(){var e=this.model.timeline();this.$stat.html(this.templateTimeline(e));var t=[];_.map(e.data,function(e,i){t.push([i,e])});var i=e.step,o=36e6>i?"%d-%m<br/> %H:%M":"%d-%b<br/>%y",n={xaxis:{mode:"time",timeformat:o,monthNames:["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"]},bars:{show:!0,barWidth:i,fillColor:"rgba(164, 170, 4, 0.3)"},colors:["rgba(164, 170, 4, 1)"]};$.plot($("#timeline-chart"),[t],n)},drawCollaboration:function(){var e=this.model.collaboration();this.$stat.html(this.templateCollaboration(e));var t=[];_.map(e.data,function(e,i){t.push({label:i,data:[[1,e]]})});var i={series:{pie:{show:!0,label:{show:!0,formatter:function(e,t){return"<div>"+e+"<br/>"+Math.round(t.percent)+"%</div>"}},combine:{threshold:.04}}},legend:{show:!1}};$.plot($("#collaboration-chart"),t,i)}})}();